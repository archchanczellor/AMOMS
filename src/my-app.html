<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="logout.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">

<script src="../bower_components/moment/moment.js"></script>

<dom-module id="my-app">

    <template>

        <style>

            :host {
                display: block;
                --app-primary-color: #4285f4;
                --app-secondary-color: black;
            }

            app-header {
                background-color: var(--app-primary-color);
                color: #fff;
            }

            app-header paper-icon-button {
                --paper-icon-button-ink-color: white;
            }

            .drawer-list {
                margin: 0 20px;
            }

            .drawer-list a {
                display: block;
                padding: 0 16px;
                line-height: 40px;
                text-decoration: none;
                color: var(--app-secondary-color);
            }

            .drawer-list div.iron-selected {
                color: black;
                font-weight: bold;
            }

            .vertical-layout {
                @apply(--layout-vertical);
            }

            .horizontal-layout {
                @apply(--layout-horizontal);
            }

            .horizontal-center {
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }

            .left-form {
                padding-right: 10px;
                /*width: 100%;*/
            }

            .right-form {
                /*width: 100%;*/
            }

            .drawer-list div.subroute {
                padding-left: 32px;
            }

            .buttons {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
                margin-top: 20px;
            }

            .appTitle {
                text-align: center;
                margin-bottom: 15px;
            }

            .appStatus {
                text-transform: capitalize;
            }

        </style>
        <app-location route="{{route}}"></app-location>
        <app-route
                route="{{route}}"
                pattern="/:page"
                data="{{routeData}}"
                tail="{{subroute}}"></app-route>
        <firebase-app api-key="AIzaSyCKmg93dL5bhlwjv_Kd493mcLbUR0ok5sI"
                      name="primary"
                      auth-domain="amoms-9ecf6.firebaseapp.com"
                      database-url="https://amoms-9ecf6.firebaseio.com"
                      storage-bucket="amoms-9ecf6.appspot.com"></firebase-app>
        <firebase-auth id="mainAuth" user="{{user}}" app-name="primary" provider="google"
                       on-error="handleError"></firebase-auth>
        <firebase-document id="filterUsers" app-name="primary" path="/users/{{user.uid}}"
                           data="{{filteredUser}}"></firebase-document>
        <firebase-document id="patientApp" app-name="primary" path="/patients/{{patientKey}}"
                           data="{{appointmentPatient}}"></firebase-document>
        <firebase-document id="pracApp" app-name="primary" path="/users/{{pracKey}}"
                           data="{{appointmentPrac}}"></firebase-document>
        <app-drawer-layout fullbleed force-narrow>
            <!-- Drawer content -->
            <app-drawer>
                <app-toolbar>Menu</app-toolbar>
                <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
                    <div hidden$="[[user]]" name="login">
                        <a name="login" href="/login" drawer-toggle>Login</a>
                    </div>
                    <div hidden$="[[!user]]" name="schedule">
                        <a href="/agenda/schedule" drawer-toggle>Schedule</a>
                    </div>
                    <div hidden$="[[!_computeSecretaryView(filteredUser.role)]]" name="patient">
                        <a href="/patient" drawer-toggle>Patient</a>
                    </div>
                    <div hidden$="[[!_computeAdminView(filteredUser.role)]]" name="users">
                        <a href="/users" drawer-toggle>Admin</a>
                    </div>
                    <!--<div hidden$="[[!user]]" name="prescription">-->
                    <!--<a href="/prescription">Create a Prescription</a>-->
                    <!--</div>-->

                </iron-selector>
            </app-drawer>

            <!-- Main content -->
            <app-header-layout has-scrolling-region>

                <app-header condenses reveals effects="waterfall">
                    <app-toolbar>
                        <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
                        <div main-title>AMOMS</div>
                        <div hidden$="[[!user]]">
                            <logout-account></logout-account>
                        </div>
                    </app-toolbar>
                </app-header>

                <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="view404" role="main">
                    <login-page name="login"></login-page>
                    <schedule-page hidden$="[[!user]]" route="[[subroute]]" name="agenda"></schedule-page>
                    <patient-page hidden$="[[!_computeSecretaryView(filteredUser.role)]]" name="patient"
                                  user="[[user]]" admin="Administrator" secretary="Secretary"
                                  practitioner="Practitioner" error-message="{{errorMessage}}"></patient-page>
                    <users-admin hidden$="[[!_computeAdminView(filteredUser.role)]]" name="users"></users-admin>
                    <!--<prescription-page name="prescription"></prescription-page>-->
                    <my-view404 name="view404"></my-view404>
                </iron-pages>

            </app-header-layout>

        </app-drawer-layout>
        <paper-dialog modal>
            <h3>Hmm...</h3>
            <p>{{errorMessage}}</p>
            <paper-button dialog-dismiss>Close</paper-button>
        </paper-dialog>

        <paper-dialog modal id="viewAppDialog" no-cancel-on-outside-click
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">
            <div class="vertical-layout">
                <div class="horizontal-center">
                    <h2 class="appTitle">[[appDetail.title]]</h2>
                </div>
                <div class="horizontal-layout">
                    <div class="left-form">
                        <p><b>Description: &nbsp</b>[[appDetail.description]]</p>
                        <p><b>Patient: &nbsp</b>[[appointmentPatient.fullName]]</p>
                        <p><b>Practitioner: &nbsp</b>[[appointmentPrac.firstName]] [[appointmentPrac.lastName]]</p>
                        <p><b>Status: </b><span class="appStatus">[[appDetail.status]]</span></p>
                    </div>
                    <div>
                        <p><b>Date: &nbsp</b>[[appDetail.eventDate]]</p>
                        <p><b>Start: &nbsp</b>[[appStart]]</p>
                        <p><b>End: &nbsp</b>[[appEnd]]</p>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button hidden$="[[!_computeSecretaryView(filteredUser.role)" on-tap="editApp">Edit</paper-button>
                <paper-button hidden$="[[!_computePractitionerView(filteredUser.role)]]" on-tap="viewApp">View
                </paper-button>
            </div>
        </paper-dialog>

        <paper-toast id="mainToast" text="{{toastMessage}}"></paper-toast>

    </template>

    <script>

        Polymer({

            is: 'my-app',

            properties: {

                page: {
                    type: String,
                    reflectToAttribute: true,
                    observer: '_pageChanged'
                },
                Administrator: {
                    type: Boolean,
                    value: null
                },
                Practitioner: {
                    type: Boolean,
                    value: null
                },
                Secretary: {
                    type: Boolean,
                    value: null
                },
                toastMessage: String,
                appDetail: Object
            },

            listeners: {
                'viewApp': 'openAppDialog'
            },

            observers: [
                '_routePageChanged(routeData.page)'
            ],

            _computeSecretaryView: function (role) {
                if (role == "Secretary" || role == "Administrator")
                    return true
                else
                    return false
            },
            _computePractitionerView: function (role) {
                if (role == "Practitioner" || role == "Administrator")
                    return true
                else
                    return false
            },
            _computeAdminView: function (role) {
                if (role == "Administrator")
                    return true
                else
                    return false
            },

            _routePageChanged: function (page) {
//                if (this.user) {
                this.page = page || 'login';
                //                }
//                else {
////                    window.history.replaceState({}, null, '/login');
//                    this.page = 'login';
//                }
            },

            _pageChanged: function (page) {
                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl(page + '.html');
                this.importHref(resolvedPageUrl, null, this._showPage404, true);
            },

            _showPage404: function () {
                this.page = 'view404';
            },

            _computeStatus: function (status) {
                if (status == 'upcoming')
                    return 0;
                else if (status == 'cancelled')
                    return 1
                else if (status == 'in-progress')
                    return 2
                else if (status == 'complete')
                    return 3
                else
                    return 4
            },

            openAppDialog: function (e) {
                this.appDetail = e.detail.calEvent;
                this.pracKey = e.detail.calEvent.practitioner
                this.patientKey = e.detail.calEvent.patient
                this.appStart = moment(e.detail.calEvent.startTime, ['HH:mm']).format('h:mm A')
                this.appEnd = moment(e.detail.calEvent.endTime, ['HH:mm']).format('h:mm A')

                this.$.viewAppDialog.open();
            },

            viewApp: function () {
                this.$.viewAppDialog.close();
                window.history.pushState({}, null, '/agenda/appointment/' + this.appDetail.$key);
                window.dispatchEvent(new CustomEvent('location-changed'));
            }
        })

    </script>

</dom-module>
