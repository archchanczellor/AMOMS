<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../bower_components/gold-phone-input/gold-phone-input.html">
<link rel="import" href="../bower_components/gold-zip-input/gold-zip-input.html">
<link rel="import" href="../bower_components/app-datepicker/app-datepicker-dialog.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../extra-files/address-autocomplete/address-autocomplete.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/poly-filter/poly-filter.html">
<link rel="import" href="../bower_components/paper-searchbox/paper-searchbox.html" ?
<link rel="import" href="shared-styles.html">
<script type="text/javascript" src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../bower_components/jquery-serialize-object/dist/jquery.serialize-object.min.js"></script>
<dom-module id="patient-page">

    <template>

        <style include="shared-styles">
            :host {
                --paper-input-container-input: {
                    max-height: 125px;
                };
                display: block;
                padding: 10px;
            }

            .center {
                @apply(--layout-vertical);
                @apply(--layout-center);
            }

            .horizontal-around {
                @apply(--layout-horizontal);
                @apply(--layout-around-justified);
            }

            .patient-info {
                background: white;
                padding: 15px 0 0 0;
                border-radius: 4px;
                min-width: 90vw;
                max-width: 90vw;
                height: auto;
            }

            .patient-content {
                @apply(--layout-horizontal);
                max-height: 35vh;
                -webkit-transition: max-height .25s;
                -moz-transition: max-height .25s;
                -ms-transition: max-height .25s;
                -o-transition: max-height .25s;
                transition: max-height .25s;
            }

            .spacer {
                height: 5vh;
            }

            .itemInfo {
                position: relative;
            }

            .itemName {
                padding: 0 5px 0 5px;
            }

            #scrollingRegion {
                border-radius: 4px;
                overflow-y: hidden;
                max-height: 79vh;
                width: 20vw;
                background-color: #fff;
                box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
                scroll-behavior: smooth;
            }

            .justifyItems {
                @apply(--layout-horizontal);
                @apply(--layout-justified);
                width: 18vw;
            }

            .buttons {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
                margin-top: 20px;
            }

            .horizontalLayout {
                @apply(--layout-horizontal);
                @apply(--layout-justified);
            }

            #firstName, #birthdate {
                padding-right: 5px;
            }

            #lastName, #gender {
                padding-left: 5px;
            }

            .horizontal-layout {
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }

            .vertical-layout {
                @apply(--layout-vertical);
            }

            .form-left {
                padding-right: 10px;
                width: 50%;
            }

            .form-right {
                width: 50%;
            }

            .justify-right {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
                padding: 20px 0;
            }

            .patients-title {
                font-weight: 100;
            }

            .add-patient-button {
                background-color: #2196F3;
                color: white;
                max-height: 50px;
            }

            .horizontal-justified {
                @apply(--layout-justified);
                padding: 0 23px
            }

            .delete-patient-button {
                color: white;
                background-color: #F44336;
            }

            .edit-patient-button {
                color: white;
                background-color: #FF5722;
                max-height: 50px;
            }

            .class[hidden] {
                display: none;
            }

            #addPatientNotes, #viewNoteDialog {
                width: 30vw;
            }
        </style>
        <firebase-query
                id="queryPatients"
                path="/patients"
                data="{{dataQuery}}"></firebase-query>
        <firebase-query
                id="queryNotes"
                path="/notes/[[uid]]"
                data="{{patientNotes}}"></firebase-query>
        <firebase-document
                id="document"
                path="/patients/"
                data="{{patientData}}"></firebase-document>
        <firebase-document
                id="documentNotes"
                path="/notes/[[uiid]]"
                data="{{patientDocNotes}}"></firebase-document>
        <!--<div class="vertical-center">-->
        <poly-filter
                array-to-filter="[[dataQuery]]"
                filter="[[patientSearch]]"
                filtered-array="{{patientData}}">
        </poly-filter>
        <div class="center">
            <paper-material class="patient-info" elevation="1">
                <div class="horizontal-justified horizontal-layout">
                    <h1 class="patients-title">Patients</h1>
                    <div class="bg-light">
                        <paper-searchbox raise-forced no-hover
                                         value="{{patientSearch::input}}"></paper-searchbox>
                    </div>
                    <div class="horizontal-layout">
                        <paper-button class="edit-patient-button" raised on-tap="_editPatient" hidden$="[[!patient]]">
                            Edit
                        </paper-button>
                        <paper-button class="add-patient-button" raised on-tap="openDialog">Add Patient</paper-button>
                    </div>
                </div>
                <vaadin-grid visible-rows="5" id="patientGrid" selection="{{patient}}">
                    <table>
                        <colgroup>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                        </colgroup>
                        <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>DOB</th>
                            <th>Gender</th>
                            <th>Street</th>
                            <th>State</th>
                            <th>City</th>
                            <th>Zip</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template is="dom-repeat" items="{{patientData}}">
                            <tr>
                                <td>[[item.fullName]]</td>
                                <td>[[item.phoneNumber]]</td>
                                <td>[[item.email]]</td>
                                <td>[[item.birthdate]]</td>
                                <td>[[item.gender]]</td>
                                <td>[[item.streetAddress1]]</td>
                                <td>[[item.state]]</td>
                                <td>[[item.city]]</td>
                                <td>[[item.zip]]</td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                </vaadin-grid>
            </paper-material>
            <!--</div>-->
            <div class="spacer"></div>
            <paper-material class="patient-info" hidden$="[[!patient]]" elevation="1">
                <div class="horizontal-justified horizontal-layout">
                    <h1 class="patients-title">Notes for [[patient.fullName]]</h1>
                    <div hidden$="[[!patient]]" class="justify-right">
                        <paper-button raised
                                      class="edit-patient-button"
                                      on-tap="_viewNoteDialog"
                                      hidden$="[[!selectedNote]]">
                            View Note</paper-button>
                        <paper-button raised class="add-patient-button" on-tap="_openNoteDialog">Add Note</paper-button>
                    </div>
                </div>
                <div hidden$="[[!patientNotes]]">
                    <vaadin-grid visible-rows="5" id="notesGrid">
                        <table>
                            <colgroup>
                                <col max-width="200">
                                <col max-width="250">
                                <col flex="1" max-width="1362">
                            </colgroup>
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Added By</th>
                                <th>Note</th>
                            </tr>
                            </thead>
                            <tbody>
                            <template is="dom-repeat" items="{{patientNotes}}">
                                <tr>
                                    <td>[[item.date]]</td>
                                    <td>[[item.creator]]</td>
                                    <td>[[item.note]]</td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </vaadin-grid>
                </div>
            </paper-material>
        </div>
        <div class="spacer"></div>
        <paper-dialog id="addPatientDialog"
                      no-cancel-on-outside-click
                      class="paper-date-picker-dialog"
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">
            <form is="iron-form" id="addPatientForm">
                <h2>Add Patient</h2>
                <div class="horizontal-layout">
                    <div class="vertical-layout form-left">
                        <div class="horizontalLayout">
                            <paper-input id="firstName" name="firstName" label="First Name" autofocus
                                         required></paper-input>
                            <paper-input id="lastName" name="lastName" label="Last Name" required></paper-input>
                        </div>
                        <gold-email-input name="email" label="Email" auto-validate required></gold-email-input>
                        <gold-phone-input name="phoneNumber" label="Phone Number" auto-validate
                                          required></gold-phone-input>
                        <paper-input name="birthdate" on-tap="openDate" id="birthdate" value="{{birthdate}}"
                                     label="Birthdate"
                                     required></paper-input>
                        <paper-dropdown-menu label="Gender" id="gender" name="gender" required>
                            <paper-menu class="dropdown-content">
                                <paper-item value="female">Female</paper-item>
                                <paper-item value="male">Male</paper-item>
                                <paper-item value="optOut">Prefer not to say</paper-item>
                            </paper-menu>
                        </paper-dropdown-menu>
                    </div>
                    <div class="address form-right">
                        <address-autocomplete></address-autocomplete>
                    </div>
                </div>
                <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button onclick="_submit()">Submit</paper-button>
                </div>
            </form>
        </paper-dialog>
        <paper-dialog id="editPatientDialog"
                      no-cancel-on-outside-click
                      class="paper-date-picker-dialog"
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">
            <form is="iron-form" id="editPatientForm">
                <h2>Edit [[patient.firstName]] [[patient.lastName]]</h2>
                <div class="horizontal-layout">
                    <div class="vertical-layout form-left">
                        <div class="horizontalLayout">
                            <paper-input id="editFirst" name="firstName" label="First Name" autofocus
                                         required value="{{patientEdit.firstName::input}}"></paper-input>
                            <paper-input id="editLast" name="lastName" label="Last Name"
                                         value="{{patientEdit.lastName::input}}" required></paper-input>
                        </div>
                        <gold-email-input name="email" label="Email" validate
                                          value="{{patientEdit.email::input}}" required></gold-email-input>
                        <gold-phone-input name="phoneNumber" label="Phone Number" validate
                                          value="{{patientEdit.phoneNumber::input}}" required></gold-phone-input>
                        <paper-input name="birthdate" on-tap="editDate" id="editDOB"
                                     value="{{patientEdit.birthdate::input}}"
                                     label="Birthdate"
                                     required></paper-input>
                        <paper-dropdown-menu label="Gender" id="editGender" name="gender" required>
                            <paper-menu class="dropdown-content" selected="{{_computeSelected(patientEdit.gender)}}">
                                <paper-item name="female" value="female">Female</paper-item>
                                <paper-item name="male" value="male">Male</paper-item>
                                <paper-item name="optOut" value="optOut">Prefer not to say</paper-item>
                            </paper-menu>
                        </paper-dropdown-menu>
                    </div>
                    <div class="address form-right">
                        <paper-input id="editAddressInput" type="text" placeholder="" name="streetAddress1" required
                                     label="Street Address 1"
                                     value="{{patientEdit.streetAddress1::input}}"></paper-input>
                        <paper-input id="editAddress2Input" type="text" name="streetAddress2"
                                     label="Street Address 2"
                                     value="{{patientEdit.streetAddress2::input}}"></paper-input>
                        <paper-input id="editCityInput" type="text" name="city" required
                                     value="{{patientEdit.city::input}}" label="City"></paper-input>
                        <paper-input id="editStateInput" type="text" name="state"
                                     value="{{patientEdit.state::input}}" required label="State"></paper-input>
                        <paper-input id="editZipCodeInput" type="text" name="zip" required
                                     label="ZIP Code" value="{{patientEdit.zip::input}}"></paper-input>
                    </div>
                </div>
                <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button on-tap="_saveEdit">Save</paper-button>
                </div>
            </form>
        </paper-dialog>
        <paper-dialog id="addPatientNotes"
                      no-cancel-on-outside-click
                      class="paper-date-picker-dialog"
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">
            <h2>Take a note...</h2>
            <div>
                <paper-textarea id="newNoteInput"
                                autofocus
                                placeholder="..."
                                value="{{newNote::input}}"
                                maxlength="500"
                                rows="1"
                                max-rows="5"
                                char-counter></paper-textarea>
            </div>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button on-tap="_saveNote">Save</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="viewNoteDialog"
                      no-cancel-on-outside-click
                      class="paper-date-picker-dialog"
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">
            <h2>Note on [[selectedNote.date]]</h2>
            <p>Created by [[selectedNote.creator]]</p>
            <p>[[selectedNote.note]]</p>
            <div class="buttons">
                <paper-button dialog-dismiss>Dismiss</paper-button>
            </div>
        </paper-dialog>
        <app-datepicker-dialog confirm-label="Confirm Date" dismiss-label="Cancel" id="datePicker"
                               date="{{birthdate}}"></app-datepicker-dialog>
        <app-datepicker-dialog confirm-label="Confirm Date" dismiss-label="Cancel"
                               input-date="{{patient.birthdate}}" id="editDate"
                               date="{{patient.birthdate}}"></app-datepicker-dialog>
        <paper-toast id="patientToast" text="{{toastMessage}}"></paper-toast>
    </template>
    <script>
        function _submit(event) {
            $('#addPatientForm').submit()
        }
    </script>
    <script>

        Polymer({

            is: 'patient-page',

            properties: {
                patientName: Object,
                patient: {
                    type: Object,
                    value: null
                },
                patientEdit: {
                    type: Object,
                    value: null
                },
                selected: String,
                errorMessage: {
                    type: String,
                    notify: true
                },
                toastMessage: String,
                tempIndex: Number,
                uid: String,
                newNote: String,
                selectedItem: {
                    type: Object,
                    value: null
                },
                showEdit: Boolean,
                selectedNote: {
                    type: Object,
                    value: null
                }
            },

            listeners: {
                'iron-form-submit': 'addPatient',
                'selected-items-changed': '_updatePatient'
            },

            _concat: function (fN, lN) {
                return fN + ' ' + lN;
            },
            _updatePatient: function (e) {
                this.patient = e.detail.item
//                this.tempIndex = e.model.index
                this.uid = this.patient.$key
            },
            _openNoteDialog: function () {
                this.$.addPatientNotes.open();
            },
            testShow: function () {
                console.log(this.selected);
            },

            openDialog: function () {
                this.$.addPatientDialog.open();
            },

            _editPatient: function () {
                this.patientEdit = this.patient;
                this.$.editPatientDialog.open();
            },
            _computeSelected: function (gender) {
                if (gender == 'Female')
                    return 0;
                else if (gender == 'Male')
                    return 1
                else
                    return 2
            },

            addPatient: function () {
                var data = $("#addPatientForm :input").serializeObject();
                data.gender = this.$.gender.value
                data.fullName = this._concat(data.firstName, data.lastName)
                this.$.document.data = data;
                this.$.document.save('/patients/').then(function () {
                    document.querySelector('#addPatientDialog').close();
                    document.querySelector('patient-page').toastMessage = "Patient has been added!";
                    document.querySelector('#patientToast').open();
                }, function () {
                    document.querySelector('patient-page').toastMessage = "Something seems to have gone wrong. Please Try again.";
                    document.querySelector('#patientToast').open();
                })
            },
            _saveEdit: function () {
                var key = this.patientEdit.$key;
                var tempData = $("#editPatientForm :input").serializeObject();
                tempData.gender = this.$.editGender.value;
                tempData.fullName = this._concat(tempData.firstName, tempData.lastName)
                this.$.document.data = tempData;
                this.$.document.save('/patients/', key).then(function () {
                    document.querySelector('#editPatientDialog').close();
                    document.querySelector('patient-page').toastMessage = "Patient has been updated!";
                    document.querySelector('#patientToast').open();
                    document.querySelector('patient-page').dirtyCheck();
                }, function () {
                    document.querySelector('patient-page').toastMessage = "Something seems to have gone wrong. Please Try again.";
                    document.querySelector('#patientToast').open();
                })
            },
            _saveNote: function () {
                var tempData = {
                    date: this._getTodaysDate(),
                    note: this.newNote,
                    creator: this.user.email
                }
                this.$.documentNotes.data = tempData;
                this.$.documentNotes.save('/notes/' + this.uid + '/').then(function () {
                    document.querySelector('#addPatientNotes').close();
                    document.querySelector('#documentNotes').path = '/notes/';
                    document.querySelector('#newNoteInput').value = ''
                    document.querySelector('patient-page').toastMessage = "Note has been added!";
                    document.querySelector('#patientToast').open();
                }, function () {
                    document.querySelector('patient-page').toastMessage = "Something seems to have gone wrong. Please Try again.";
                    document.querySelector('#patientToast').open();
                })
                tempData = null
            },
            openDate: function () {
                this.$.datePicker.open();
            },
            editDate: function () {
                this.$.editDate.open();
            },
            dirtyCheck: function () {
                this.async(function () {
                    this.patient = null;
                    this.patientEdit = null;
                    var temp = this.dataQuery;
                    this.set('dataQuery', []);
                    this.set('dataQuery', temp);
                }, 500)
            },
            _getTodaysDate: function () {
                var today = new Date();
                return today.toLocaleString()
            },
            _viewNoteDialog: function() {
                this.$.viewNoteDialog.open()
            },
            ready: function () {
                var grid = document.querySelector('#patientGrid')
                var noteGrid = document.querySelector('#notesGrid')

                grid.addEventListener('selected-items-changed', function () {
                    this.selection.selected(function (index) {
                        var dataPage = document.querySelector('patient-page');
                        dataPage.patient = dataPage.patientData[index];
                        dataPage.uid = dataPage.patient.$key;
                        dataPage.selectedNote = null;
                    });
                }.bind(grid));

                noteGrid.addEventListener('selected-items-changed', function () {
                    this.selection.selected(function (index) {
                        var notePage = document.querySelector('patient-page')
                        notePage.selectedNote = notePage.patientNotes[index];
                    })
                }.bind(noteGrid))
//                grid.rowDetailsGenerator = function(rowIndex) {
//                    var element = document.createElement('div');
//
//                    grid.getItem(rowIndex, function(error, item) {
//                        if (!error) {
//                            // The getUserDetails should return HTML.
//                            element.innerHTML = item[0]
//                        }
//                    });
//
//                    return element;
//                };
//                var detailsOpenIndex = -1;
//
//                // Show details for the selected row
//                grid.addEventListener('selected-items-changed', function() {
//                    grid.setRowDetailsVisible(detailsOpenIndex, false);
//                    var selected = grid.selection.selected();
//                    if (selected.length == 1) {
//                        grid.setRowDetailsVisible(selected[0], true);
//                        detailsOpenIndex = selected[0];
//                    }
//                });
            }
        })
    </script>

</dom-module>
