<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/paper-searchbox/paper-searchbox.html">
<link rel="import" href="../bower_components/poly-filter/poly-filter.html">
<link rel="import" href="shared-styles.html">
<script type="text/javascript" src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../bower_components/jquery-serialize-object/dist/jquery.serialize-object.min.js"></script>
<dom-module id="users-admin">

    <template>
        <style include="shared-styles">
            :host {
                display: block;
                height: 100vh;
            }

            .center-page {
                height: 75vh;
                @apply(--layout-horizontal);
                @apply(--layout-center-center);
            }

            .center-item {
                height: 100%;
                @apply(--layout-horizontal);
                @apply(--layout-center-center);
            }

            paper-button {
                color: white;
                background-color: blue;
            }

            .center {
                @apply(--layout-vertical);
                @apply(--layout-center);
            }

            .horizontal-around {
                @apply(--layout-horizontal);
                @apply(--layout-around-justified);
            }

            .user-info {
                background: white;
                padding: 15px 25px 0 25px;
                border-radius: 4px;
                min-width: 60vw;
                width: 90vw;
            }

            .user-content {
                @apply(--layout-vertical);
                height: 35vh;
                padding: 15px 15px 15px 5px;
                -webkit-transition: max-height .25s;
                -moz-transition: max-height .25s;
                -ms-transition: max-height .25s;
                -o-transition: max-height .25s;
                transition: max-height .25s;
            }

            .spacer {
                height: 5vh;
            }

            .itemInfo {
                position: relative;
            }

            .itemName {
                padding: 0 5px 0 5px;
            }

            #scrollingRegion {
                border-radius: 4px;
                overflow-y: hidden;
                max-height: 79vh;
                width: 20vw;
                background-color: #fff;
                box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
                scroll-behavior: smooth;
            }

            .justifyItems {
                @apply(--layout-horizontal);
                @apply(--layout-justified);
                width: 18vw;
            }

            .buttons {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
            }

            .horizontalLayout {
                @apply(--layout-horizontal);
                @apply(--layout-justified);
            }

            #firstName, #birthdate {
                padding-right: 5px;
            }

            #lastName, #gender {
                padding-left: 5px;
            }

            .horizontal-layout {
                @apply(--layout-horizontal);
            }

            .vertical-layout {
                @apply(--layout-vertical);
            }

            .form-left {
                padding-right: 10px;
                width: 50%;
            }

            .form-right {
                width: 50%;
            }

            .justify-right {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
            }

            .user-title {
                padding: 0 20px;
            }

            .horizontal-justified {
                @apply(--layout-justified);
            }

            .delete-user-button {
                color: white;
                background-color: #F44336;
            }

            .add-user-button {
                background-color: #2196F3;
                color: white;
                max-height: 50px;
            }

            .edit-user-button {
                color: white;
                background-color: #FF5722;
                max-height: 50px;
            }

            .class[hidden] {
                display: none;
            }

            .user-heading {
                padding: 10px 0 10px 0;
                @apply(--layout-horizontal);
                @apply(--layout-justified);
            }

            search-box {
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }
        </style>

        <firebase-app api-key="AIzaSyCKmg93dL5bhlwjv_Kd493mcLbUR0ok5sI"
                      name="secondary"
                      auth-domain="amoms-9ecf6.firebaseapp.com"
                      database-url="https://amoms-9ecf6.firebaseio.com"
                      storage-bucket="amoms-9ecf6.appspot.com"></firebase-app>
        <firebase-auth id="createUser" app-name="secondary" user="{{tempUser}}" provider="google"
                       on-error="showError"></firebase-auth>
        <firebase-query
                id="queryUsers"
                app-name="primary"
                path="/users"
                data="{{dataQuery}}"></firebase-query>
        <firebase-document
                id="saveUserData"
                app-name="primary"
                path="/users/"
                data="{{userData}}"></firebase-document>
        <firebase-auth id="primaryAuth" app-name="primary" user="{{user}}" provider="google"
                       on-error="showError"></firebase-auth>
        <poly-filter
                array-to-filter="[[dataQuery]]"
                filter="[[userSearch]]"
                filtered-array="{{searchedUsers}}">
        </poly-filter>
        <div class="horizontal-around">
            <div class="center">
                <div class="center-page">
                    <paper-material class="user-info" elevation="5">
                        <div class="user-heading">
                            <h1>Users</h1>
                            <div class="search-box">
                                <paper-searchbox raise-forced no-hover
                                                 value="{{userSearch::input}}"></paper-searchbox>
                            </div>
                            <div class="justify-right">
                                <paper-button raised class="edit-user-button" hidden$="[[!someUser]]"
                                              on-tap="_openEditUserDialog">Edit User
                                </paper-button>
                                <paper-button raised class="add-user-button" on-tap="_openAddUserDialog">Add User
                                </paper-button>
                            </div>
                        </div>
                        <vaadin-grid aria-label="Users" class="material" id="usersGrid" items="[[searchedUsers]]"
                                     active-item="{{userItem}}" size="200">
                            <vaadin-grid-column>
                                <template class="header">
                                    <vaadin-grid-sorter path="lastName">Name</vaadin-grid-sorter>
                                </template>
                                <template>[[item.firstName]]&nbsp;[[item.lastName]]</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Email</template>
                                <template>[[item.email]]</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">
                                    <vaadin-grid-sorter path="role">Role</vaadin-grid-sorter>
                                </template>
                                <template>[[item.role]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                    </paper-material>
                </div>
            </div>
        </div>


        <div class="spacer"></div>
        <paper-dialog id="addUserDialog"
                      no-cancel-on-outside-click
                      class=""
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">
            <form is="iron-form" id="addUserForm">
                <h2>Add User</h2>
                <div class="horizontal-layout">
                    <div class="vertical-layout">
                        <div class="horizontalLayout">
                            <paper-input id="userFirstName" name="firstName" label="First Name" autofocus
                                         required></paper-input>
                            <paper-input id="userLastName" name="lastName" label="Last Name" required></paper-input>
                        </div>
                        <gold-email-input name="email" id="userEmail" label="Email" auto-validate
                                          required></gold-email-input>
                        <paper-input type="password" id="userPassword" name="password" label="Password"
                                     required></paper-input>
                        <paper-dropdown-menu label="role" id="userRole" name="Role" required>
                            <paper-menu class="dropdown-content">
                                <paper-item name="administrator" value="administrator">Administrator</paper-item>
                                <paper-item name="secretary" value="secretary">Secretary</paper-item>
                                <paper-item name="practitioner" value="practitioner">Practitioner</paper-item>
                            </paper-menu>
                        </paper-dropdown-menu>
                    </div>
                </div>
                <div class="buttons">
                    <paper-button dialog-dismiss>Close</paper-button>
                    <paper-button on-tap="addUser">Submit</paper-button>
                </div>
            </form>
        </paper-dialog>
        <paper-toast id="userToast" text="{{toastMessage}}"></paper-toast>
        <paper-dialog id="editUserDialog"
                      no-cancel-on-outside-click
                      class=""
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">
            <form is="iron-form" id="editUserForm">
                <h2>Edit [[user.firstName]] [[user.lastName]]</h2>
                <div class="horizontal-layout">
                    <div class="vertical-layout">
                        <div class="horizontalLayout">
                            <paper-input id="editFirst" name="firstName" label="First Name" autofocus
                                         required value="{{userEdit.firstName::input}}"></paper-input>
                            <paper-input id="editLast" name="lastName" label="Last Name"
                                         value="{{userEdit.lastName::input}}" required></paper-input>
                        </div>
                        <gold-email-input name="email" label="Email" validate
                                          value="{{userEdit.email::input}}" required></gold-email-input>
                        <paper-dropdown-menu label="role" id="editRole" name="Role" required>
                            <paper-menu class="dropdown-content" selected="{{_computeSelected(userEdit.role)}}">
                                <paper-item name="administrator" value="administrator">Administrator</paper-item>
                                <paper-item name="secretary" value="secretary">Secretary</paper-item>
                                <paper-item name="practitioner" value="practitioner">Practitioner</paper-item>
                            </paper-menu>
                        </paper-dropdown-menu>
                    </div>
                </div>
                <div class="buttons">
                    <paper-button dialog-dismiss>Close</paper-button>
                    <paper-button on-tap="_saveUser">Submit</paper-button>
                </div>
            </form>
        </paper-dialog>
        <paper-toast id="userToast" text="{{toastMessage}}"></paper-toast>
    </template>
    <script>

        Polymer({

            is: 'users-admin',

            properties: {
                someUser: {
                    type: Object,
                    value: null
                },
                userEdit: {
                    type: Object,
                    value: null
                },
                toastMessage: String,
                key: String,
                userItem: {
                    observer: '_selectUser'
                }
            },

            addUser: function () {
                this.$.createUser.createUserWithEmailAndPassword(this.$.userEmail.value, this.$.userPassword.value).then(function (firebaseUser) {
                    //success
                    document.querySelector('users-admin').key = firebaseUser.uid;
                    document.querySelector('users-admin').saveUserData();
                }, function () {
                    //failure
                    document.querySelector('users-admin').toastMessage = "Something seems to have gone wrong. Please Try again.";
                    document.querySelector('#userToast').open();
                })
            },
            saveUserData: function () {
                this.$.saveUserData.data = {
                    firstName: this.$.userFirstName.value,
                    lastName: this.$.userLastName.value,
                    email: this.$.userEmail.value,
                    role: this.$.userRole.value
                }
                this.$.saveUserData.save('/users', this.key).then(function () {
                    document.querySelector('#addUserDialog').close();
                    document.querySelector('users-admin').toastMessage = "User has been added!";
                }, function (e) {
                    document.querySelector('users-admin').toastMessage = "Something seems to have gone wrong. Please Try again.";
                    document.querySelector('#userToast').open();
                })

            },
            _saveUser: function () {
                var key = this.userEdit.$key;
                var tempData = $("#editUserForm :input").serializeObject();
                tempData.role = this.$.editRole.value;
                this.$.saveUserData.data = tempData;
                this.$.saveUserData.save('/users/', key).then(function () {
                    document.querySelector('#editUserDialog').close();
                    document.querySelector('users-admin').toastMessage = "User has been updated!";
                    document.querySelector('#userToast').open();
                    document.querySelector('users-admin').userEdit = null;
                }, function () {
                    document.querySelector('users-admin').toastMessage = "Something seems to have gone wrong. Please Try again.";
                    document.querySelector('#userToast').open();
                })
            },
            _computeSelected: function (role) {
                if (role == 'Administrator')
                    return 0;
                else if (role == 'Secretary')
                    return 1
                else
                    return 2
            },
            _openAddUserDialog: function () {
                this.$.addUserDialog.open();
            },
            _openEditUserDialog: function () {
                this.userEdit = this.someUser;
                this.$.editUserDialog.open();
            },

            _selectUser: function (item) {
                this.someUser = item
                this.$.usersGrid.selectedItems = item ? [item] : []
            },

            ready: function () {
                var userGrid = document.querySelector('#usersGrid');
                userGrid.addEventListener('selected-items-changed', function () {
                    this.selection.selected(function (index) {
                        var dataPage = document.querySelector('users-admin');
                        dataPage.someUser = dataPage.dataQuery[index];
                    });
                }.bind(userGrid));
            }
        });
    </script>
</dom-module>
