<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/dialog-el/dialog-el.html">
<link rel="import" href="prescription.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<dom-module id="appointment-page">

    <template>

        <style include="shared-styles">
            .horizontal-around {
                @apply(--layout-horizontal);
                @apply(--layout-around-justified);
            }

            .horizontal-justified {
                @apply(--layout-horizontal);
                @apply(--layout-justified);
            }

            .horizontal {
                @apply(--layout-horizontal);
            }

            .horizontal-center {
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }

            .center {
                @apply(--layout-horizontal);
                @apply(--layout-center-center);
            }

            .cancelled {
                background-color: #F44336;
                color: white
            }

            .in-progress {
                background-color: #FFFF00;
                color: black;
            }

            .completed {
                background-color: #00E676;
                color: black;
            }

            paper-material {
                min-width: 50vw;
                max-width: 95vw;
                padding: 20px;
            }

            .start-appointment {
                background-color: #4285f4;
                color: white;
                height: 50px;
            }

            .end-appointment {
                background-color: #F44336;
                color: white;
                height: 50px;
            }

            .notes-card {
                margin-top: 20px;
            }

            .buttons {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
                @apply(--layout-center);
            }

            .edit-patient-button {
                color: white;
                background-color: #FF5722;
                max-height: 50px;
            }

            .add-patient-button {
                background-color: #2196F3;
                color: white;
                max-height: 50px;
            }

            #addAppPatientNotes {
                min-width: 30vw;
            }

            .fixed-back {
                position: fixed;
                left: 20px;
                top: 84px;
                color: black;
            }

            .arrow-back {
                color: black
            }

            .add-prescription-dialog {
                width: 30vw;
            }
        </style>
        <iron-location path="{{path}}" hash="{{hash}}" query="{{query}}" dwell-time="{{dwellTime}}"></iron-location>

        <firebase-auth id="appointmentAuth" user="{{user}}" app-name="primary" provider="google"
                       on-error="handleError"></firebase-auth>
        <firebase-document id="agendaAppointment" app-name="primary" path="/appointments/{{query}}"
                           data="{{appDetail}}"></firebase-document>
        <firebase-document id="patientAppointment" app-name="primary" path="/patients/{{appDetail.patient}}"
                           data="{{appPatient}}"></firebase-document>
        <firebase-document id="practitionerAppointment" app-name="primary" path="/users/{{appDetail.practitioner}}"
                           data="{{appPrac}}"></firebase-document>
        <firebase-query id="appPatientNotes" app-name="primary" path="{{appDetailPath}}"
                        data="{{appNotes}}"></firebase-query>
        <firebase-query id="appPatientPrescriptions" app-name="primary" path="/prescriptions/{{appDetail.patient}}"
                        data="{{patientPrescriptions}}"></firebase-query>
        <firebase-document id="editNoteDoc" app-name="primary" path="/notes/{{appDetail.patient}}/{{editNoteKey}}"
                           data="{{editableNote}}"></firebase-document>
        <firebase-document id="saveNewNoteApp" app-name="primary" path="/notes/{{appDetail.patient}}/{{editNoteKey}}"
                           data="{{savableNote}}"></firebase-document>
        <div class="fixed-back">
            <paper-icon-button class="arrow-back" icon="arrow-left"></paper-icon-button>
        </div>
        <div class="center notes-card">
            <paper-material elevation="2">
                <h2 class="appTitle">[[appTitle]]</h2>
                <p>Description: &nbsp;[[appDetail.description]]</p>
                <p>Patient: &nbsp;[[appPatient.fullName]]</p>
                <p>Practitioner: &nbsp;[[appPrac.firstName]] [[appPrac.lastName]]</p>
                <div class="horizontal-justified">
                    <p>Status: &nbsp;[[appDetail.status]]</p>
                    <paper-button class="start-appointment" raised hidden$="[[_computeStart(statusChange)]]"
                                  on-tap="startApp">Start
                        Appointment
                    </paper-button>
                    <paper-button class="end-appointment" raised hidden$="[[_computeEnd(statusChange)]]"
                                  on-tap="endApp">End Appointment
                    </paper-button>
                </div>
                <p></p>
            </paper-material>
        </div>
        <div class="center notes-card">
            <paper-material elevation="1">
                <div class="horizontal-justified">
                    <h2 class="pageTitle">Notes</h2>
                    <div class="buttons">
                        <paper-button raised class="edit-patient-button" on-tap="_viewEditableNoteDialog"
                                      hidden$="[[!selectedNote]]">View Note
                        </paper-button>
                        <paper-button raised class="add-patient-button" on-tap="_openNoteDialog">Add Note</paper-button>
                    </div>
                </div>
                <vaadin-grid aria-label="Notes" class="material" id="notesGrid" items="[[appNotes]]" active-item="{{noteItem}}" size="200">
                    <vaadin-grid-column>
                        <template class="header">
                            <vaadin-grid-sorter path="date">Date</vaadin-grid-sorter>
                        </template>
                        <template>[[item.date]]</template>
                    </vaadin-grid-column>

                    <vaadin-grid-column>
                        <template class="header">
                            <vaadin-grid-sorter path="creator">Added By</vaadin-grid-sorter>
                        </template>
                        <template>[[item.creator]]</template>
                    </vaadin-grid-column>

                    <vaadin-grid-column>
                        <template class="header">Note</template>
                        <template>
                            <p style="white-space: normal">[[item.note]]</p>
                        </template>
                    </vaadin-grid-column>

                </vaadin-grid>
            </paper-material>
        </div>
        <div class="center notes-card">
            <paper-material elevation="1">
                <div class="horizontal-justified">
                    <h2 class="pageTitle">Prescriptions</h2>
                    <div class="buttons">
                        <paper-button class="edit-prescription" hidden$="[[!selectedPrescription]]">Edit</paper-button>
                        <paper-button class="start-appointment" on-tap="_addPrescription" raised>Add Prescription
                        </paper-button>
                    </div>
                </div>
                <vaadin-grid id="prescriptionGrid" aria-label="Prescriptions" class="material" items="[[patientPrescriptions]]" active-item="{{prescriptionItem}}" size="200">
                    <vaadin-grid-column>
                        <template class="header">
                            <vaadin-grid-sorter path="date">Date</vaadin-grid-sorter>
                        </template>
                        <template>[[item.date]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">
                            <vaadin-grid-sorter path="practitioner">Prescribed By</vaadin-grid-sorter>
                        </template>
                        <template>[[item.practitioner]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Prescribed Drug</template>
                        <template>[[item.drugName]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Prescribed Amount</template>
                        <template>[[item.drugAmount]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Directions</template>
                        <template>[[item.drugDirections]]</template>
                    </vaadin-grid-column>
                </vaadin-grid>
            </paper-material>
        </div>
        <!--add note-->
        <paper-dialog id="addAppPatientNotes" no-cancel-on-outside-click entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">
            <h2>Take a note</h2>
            <div>
                <paper-textarea id="newNoteAppInput"
                                autofocus
                                placeholder="..."
                                value="{{newNote::input}}"
                                maxlength="500"
                                rows="1"
                                max-rows="5"
                                char-counter></paper-textarea>
            </div>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button on-tap="_saveAppNote">Save</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="addPrescriptionDialog" class="add-prescription-dialog">
            <prescription-page user="[[user]]" patient="[[appDetail.patient]]"></prescription-page>
        </paper-dialog>
        <paper-dialog id="editNoteDialogApp" class="fixed-dialog-width">
            <div hidden$="[[editing]]">
                <h4>View Note on [[editableNote.date]]</h4>
                <p>[[editableNote.note]]</p>
                <div class="buttons">
                    <paper-button dialog-dismiss>Dismiss</paper-button>
                    <paper-button on-tap="_editNote">Edit</paper-button>
                </div>
            </div>
            <div hidden$="[[!editing]]">
                <h4>Edit Note on [[editNote.date]]</h4>
                <paper-textarea id="newNoteAppInput" autofocus value="{{editNote.note::input}}" rows="1"
                                maxlength="500" max-rows="5" char-counter ></paper-textarea>
                <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button on-tap="_saveNote">Save</paper-button>
                </div>
            </div>
        </paper-dialog>
        <paper-toast id="appointmentToast" text="{{toastMessage}}"></paper-toast>
    </template>

    <script>
        Polymer({
            is: 'appointment-page',
            properties: {
                toastMessage: String,
                pracKey: String,
                patientKey: String,
                appKey: {
                    type: String,
                    value: null
                },
                appStart: {
                    type: Boolean,
                    value: false
                },
                appEnd: {
                    type: Boolean,
                    value: true
                },
                notesKey: String,
                appTitle: {
                    type: String,
                    value: 'Loading...'
                },
                editNoteKey: {
                    type: String,
                    value: null
                },
                newNote: String,
                statusChange: {
                    type: String,
                    value: null
                },
                editPrescriptionKey: {
                    type: String,
                    value: null
                },
                selectedNote: {
                    type: Object,
                    value: null
                },
                selectedPrescription: {
                    type: Object,
                    value: null
                },
                testAppNotes: {
                    type: Array,
                    value: null
                },
                editing: {
                    type: Boolean,
                    value: false
                },
                editNote: Object,
                appDetail: {
                    type: Object,
                    value: null
                },
                appDetailPath: {
                    type: String,
                    value: null
                },
                query: {
                    type: String,
                    observer: '_setNotesPath'
                },
                noteItem: {
                    observer: '_noteItemChanged'
                },
                prescriptionItem: {
                    observer: '_prescriptionItemChanged'
                }

            },

            listeners: {
                'refreshNotes': 'updateNotesList'
            },

            observers: [
                '_formatTitle(appDetail.title)',
                '_statusChange(appDetail.status)',
                '_setNotesPath(appDetail.patient)'

            ],

            _noteItemChanged: function (item) {
                this.selectedNote = item;
                this.$.notesGrid.selectedItems = item ? [item] : [];
            },

            _prescriptionItemChanged: function (item) {
                this.selectedPrescription = item
                this.$.prescriptionGrid.selectedItems = item ? [item] : []
            },

            _setNotesPath: function (key) {
                this.async(function () {
                    this.appDetailPath = null
                    this.appDetailPath = '/notes/' + key
                })
            },

            _formatTitle: function (title) {
                if (title) {
                    var temp = title.split("-")
                    this.appTitle = temp[0];
                }
            },
            _statusChange: function (status) {
                this.statusChange = status
            },
            _computeSelected: function (status) {
                if (status == 'upcoming')
                    return 0;
                else if (status == 'cancelled')
                    return 1
                else if (status == 'in-progress')
                    return 2
                else if (status == 'complete')
                    return 3
                else
                    return 4
            },
            saveAppointmentData: function () {
                this.$.saveAppointmentData.data = {
                    status: this.$.status.value
                }
                this.$.saveAppointmentData.save('/schedule/appointment/{uid}', this.key).then(function () {
                    document.querySelector('#editAppointmentStatus').close();
                    document.querySelector('appointment-page').toastMessage = "User has been added!";
                }, function (e) {
                    document.querySelector('appointment-page').toastMessage = "Something seems to have gone wrong. Please Try again.";
                    document.querySelector('#appointmentToast').open();
                })

            },
            _saveAppointment: function () {
                var key = this.userEdit.$key;
                var tempData = $("#appointmentStatusForm :input").serializeObject();
                tempData.status = this.$.editStatus.value;
                this.$.saveAppointmentData.data = tempData;
                this.$.saveAppointmentData.save('/schedule/appointment/', key).then(function () {
                    document.querySelector('#editAppointmentStatus').close();
                    document.querySelector('appointment-page').toastMessage = "User has been updated!";
                    document.querySelector('#appointmentToast').open();
                    document.querySelector('appointment-page').userEdit = null;
                }, function () {
                    document.querySelector('appointment-page').toastMessage = "Something seems to have gone wrong. Please Try again.";
                    document.querySelector('#appointmentToast').open();
                })
            },
            _viewEditableNoteDialog: function () {
//                this.fire('viewNote', {editNoteKey: this.selectedNote.$key, editNotePatientKey: this.appDetail.patient})
                this.editNoteKey = this.selectedNote.$key
                this.editing = false
                this.$.editNoteDialogApp.open()
            },
            _openNoteDialog: function () {
                this.$.addAppPatientNotes.open()
            },
            _saveAppNote: function () {
                var tempData = {
                    date: this._getTodaysDate(),
                    note: this.newNote,
                    creator: this.user.email
                }
                this.$.saveNewNoteApp.data = tempData;
                this.$.saveNewNoteApp.save('/notes/' + this.appDetail.patient + '/').then(function () {
                    document.querySelector('#addAppPatientNotes').close();
                    document.querySelector('#saveNewNoteApp').path = '/notes/';
                    document.querySelector('#newNoteAppInput').value = ''
                    document.querySelector('my-app').toastMessage = "Note has been added!";
                    document.querySelector('#mainToast').open();
                }, function () {
                    document.querySelector('appointment-page').toastMessage = "Something seems to have gone wrong. Please Try again.";
                    document.querySelector('#appointmentToast').open();
                })
                tempData = null
            },
            _getTodaysDate: function () {
                var today = new Date();
                return today.toLocaleString()
            },
            startApp: function () {
                this.set('appDetail.backgroundColor', '#FF9800')
                this.set('appDetail.textColor', 'black')
                this.set('appDetail.status', "In-Progress")
                if (document.querySelector('schedule-page'))
                    document.querySelector('schedule-page').fire('updateAgenda')
            },
            endApp: function () {
                this.set('appDetail.backgroundColor', '#2196F3')
                this.set('appDetail.textColor', 'white')
                this.set('appDetail.status', "Concluded")
                if (document.querySelector('schedule-page'))
                    document.querySelector('schedule-page').fire('updateAgenda')
            },
            _computeStart: function (status) {
                if (status == "In-Progress" || status == "Concluded")
                    return true
                return false
            },
            _computeEnd: function (status) {
                if (status == "In-Progress")
                    return false
                return true
            },
            _addPrescription: function () {
                this.$.addPrescriptionDialog.open();
            },
            updateNotesList: function () {
                this.async(function () {
                    this.appDetailPath = null
                    this.appDetailPath.path = '/notes/' + this.appDetail.patient
                }, 1000)
            },
            _editNote: function () {
                this.editNote = this.editableNote;
                this.editing = true
            },
            _saveNote: function () {
//                this.$.editNoteDocumentMain.path = '/notes/' + this.editNotePatientKey +'/' + this.editNoteKey + '/'
                this.editableNote = {}
                this.editableNote = this.editNote
//                document.querySelector('appointment-page').fire('refreshNotes')
                this.async(function () {
                    this.$.appPatientNotes.path = null
                    this.$.appPatientNotes.path = '/notes/' + this.appDetail.patient
                }, 1000)
                this.editing = false
//                this.$.editNoteDocumentMain.path = '/notes/' + this.editNotePatientKey +'/' + this.editNoteKey
            }
        })
    </script>

</dom-module>